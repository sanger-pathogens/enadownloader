default:
  tags:
    - autoscale

workflow:
  rules:
    - if: $CI_COMMIT_TAG
      when: never
    - when: always

stages:
  - format
  - test
  - build
  - tag_on_merges

# this fragment starts the Docker daemon inside the CI-launched
# container
.start_docker: &start_docker
  before_script:
    - mkdir -p /etc/docker
    - echo '{"registry-mirrors":["https://docker-hub-mirror.internal.sanger.ac.uk:5000"],"default-address-pools":[{"base":"192.168.4.0/16","size":24}]}' > /etc/docker/daemon.json
    - dockerd > /var/log/dockerd.log 2>&1 &
    - sleep 10
    - echo -n ${CI_JOB_TOKEN} | docker login -u gitlab-ci-token --password-stdin ${CI_REGISTRY}

.build_and_push: &build_and_push
  - export TAG=$(echo ${TAG} | sed s';/;_;g')
  - export IMAGE="${CI_REGISTRY_IMAGE}:${TAG}"
  - echo "üê≥ Building ${IMAGE} üê≥"
  - docker build --no-cache -t "${IMAGE}" --target runner .
  - echo "üê≥ Pushing ${IMAGE} üê≥"
  - docker push ${IMAGE}

#Check Black format:
#  stage: format
#  only:
#    - branches
#  except:
#    - tags
#  script:
#    - pip install black
#    - black . --check --diff --color

# at every git push, build docker image and push to the container registry with the commit SHA-1 as the tag
Branch builds:
  stage: build
  variables:
    TAG: "${CI_COMMIT_BRANCH}-${CI_COMMIT_SHORT_SHA}"
  only:
    - branches
  except:
    - tags
  <<: *start_docker
  script:
    - *build_and_push
    - docker images -f reference=${CI_REGISTRY_IMAGE} -f before=${IMAGE}

#Tag builds:
#  stage: build
#  variables:
#    TAG: "${CI_COMMIT_TAG}-${CI_COMMIT_SHORT_SHA}"
#  only:
#    - tags
#  except:
#    - branches
#  <<: *start_docker
#  <<: *build_and_push
#  after_script:
#    - docker images -f reference=${CI_REGISTRY_IMAGE} -f before=${IMAGE}
